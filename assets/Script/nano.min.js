!function(e,p){var v=e,t=v.Package={},r=v.Message={};t.TYPE_HANDSHAKE=1,t.TYPE_HANDSHAKE_ACK=2,t.TYPE_HEARTBEAT=3,t.TYPE_DATA=4,t.TYPE_KICK=5,r.TYPE_REQUEST=0,r.TYPE_NOTIFY=1,r.TYPE_RESPONSE=2,r.TYPE_PUSH=3,v.strencode=function(e){for(var t=new p(3*e.length),n=0,o=0;o<e.length;o++){var r=e.charCodeAt(o),i=null;i=r<=127?[r]:r<=2047?[192|r>>6,128|63&r]:[224|r>>12,128|(4032&r)>>6,128|63&r];for(var c=0;c<i.length;c++)t[n]=i[c],++n}var s=new p(n);return y(s,0,t,0,n),s},v.strdecode=function(e){for(var t=new p(e),n=[],o=0,r=0,i=t.length;o<i;)t[o]<128?(r=t[o],o+=1):t[o]<224?(r=((63&t[o])<<6)+(63&t[o+1]),o+=2):(r=((15&t[o])<<12)+((63&t[o+1])<<6)+(63&t[o+2]),o+=3),n.push(r);return String.fromCharCode.apply(null,n)},t.encode=function(e,t){var n=t?t.length:0,o=new p(4+n),r=0;return o[r++]=255&e,o[r++]=n>>16&255,o[r++]=n>>8&255,o[r++]=255&n,t&&y(o,4,t,0,n),o},t.decode=function(e){for(var t=0,n=new p(e),o=0,r=[];t<n.length;){var i=n[t++],c=(o=(n[t++]<<16|n[t++]<<8|n[t++])>>>0)?new p(o):null;y(c,0,n,t,o),t+=o,r.push({type:i,body:c})}return 1===r.length?r[0]:r},r.encode=function(e,t,n,o,r){var i=1+(E(t)?a(e):0);if(T(t))if(n){if("number"!=typeof o)throw new Error("error flag for number route!");i+=2}else if(i+=1,o){if(255<(o=v.strencode(o)).length)throw new Error("route maxlength is overflow");i+=o.length}r&&(i+=r.length);var c=new p(i),s=0;return s=u(t,n,c,s),E(t)&&(s=l(e,c,s)),T(t)&&(s=f(n,o,c,s)),r&&(s=d(r,c,s)),c},r.decode=function(e){var t=new p(e),n=t.length||t.byteLength,o=0,r=0,i=null,c=t[o++],s=1&c,a=c>>1&7;if(E(a)){var u=parseInt(t[o]),l=0;do{r+=(127&(u=parseInt(t[o])))*Math.pow(2,7*l),o++,l++}while(128<=u)}if(T(a))if(s)i=t[o++]<<8|t[o++];else{var f=t[o++];i=f?(i=new p(f),y(i,0,t,o,f),v.strdecode(i)):"",o+=f}var d=n-o,h=new p(d);return y(h,0,t,o,d),{id:r,type:a,compressRoute:s,route:i,body:h}};var y=function(e,t,n,o,r){if("function"==typeof n.copy)n.copy(e,t,o,o+r);else for(var i=0;i<r;i++)e[t++]=n[o++]},E=function(e){return e===r.TYPE_REQUEST||e===r.TYPE_RESPONSE},T=function(e){return e===r.TYPE_REQUEST||e===r.TYPE_NOTIFY||e===r.TYPE_PUSH},a=function(e){for(var t=0;t+=1,0<(e>>=7););return t},u=function(e,t,n,o){if(e!==r.TYPE_REQUEST&&e!==r.TYPE_NOTIFY&&e!==r.TYPE_RESPONSE&&e!==r.TYPE_PUSH)throw new Error("unkonw message type: "+e);return n[o]=e<<1|(t?1:0),o+1},l=function(e,t,n){do{var o=e%128,r=Math.floor(e/128);0!==r&&(o+=128),t[n++]=o,e=r}while(0!==e);return n},f=function(e,t,n,o){if(e){if(65535<t)throw new Error("route number is overflow");n[o++]=t>>8&255,n[o++]=255&t}else t?(n[o++]=255&t.length,y(n,o,t,0,t.length),o+=t.length):n[o++]=0;return o},d=function(e,t,n){return y(t,n,e,0,e.length),n+e.length};"undefined"!=typeof window&&(window.Protocol=v)}("undefined"==typeof window?module.exports:this.Protocol={},"undefined"==typeof window?Buffer:Uint8Array),function(){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}n.prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},n.prototype.once=function(e,t){var n=this;function o(){n.off(e,o),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},o.fn=t,this.on(e,o),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,o=this._callbacks[e];if(!o)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r=0;r<o.length;r++)if((n=o[r])===t||n.fn===t){o.splice(r,1);break}return this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var o=0,r=(n=n.slice(0)).length;o<r;++o)n[o].apply(this,t);return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length};var i=window.Protocol,c=i.Package,s=i.Message,e=n,a=window.rsa;"function"!=typeof Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t});var t=window,u=Object.create(e.prototype);t.nano=u;var l,r=null,o=0,f={},d={},h={},p={},v={},y=0,E=0,T=0,_=null,w=null,b=null,g=null,m=null,P=!1,Y=null,A=null,S=0,k=5e3,N={sys:{type:"js-websocket",version:"0.0.1",rsa:{}},user:{}},O=null;u.init=function(e,t){O=t;var n=e.host,o=e.port,r=e.path;m=e.encode||R,g=e.decode||H;var i="ws://"+n;if(o&&(i+=":"+o),r&&(i+=r),N.user=e.user,e.encrypt){l=!0,a.generate(1024,"10001");var c={rsa_n:a.n.toString(16),rsa_e:a.e};N.sys.rsa=c}b=e.handshakeCallback,K(e,i,t)};var H=u.decode=function(e){var t=s.decode(e);if(!(0<t.id)||(t.route=h[t.id],delete h[t.id],t.route))return t.body=Q(t),t},R=u.encode=function(e,t,n){var o=e?s.TYPE_REQUEST:s.TYPE_NOTIFY;n=i.strencode(JSON.stringify(n));var r=0;return p&&p[t]&&(t=p[t],r=1),s.encode(e,o,r,t,n)},K=function(t,e,n){console.log("connect to "+e);var o=(t=t||{}).maxReconnectAttempts||10;(r=new WebSocket(A=e)).binaryType="arraybuffer",r.onopen=function(e){P&&u.emit("reconnect"),D();var t=c.encode(c.TYPE_HANDSHAKE,i.strencode(JSON.stringify(N)));C(t)},r.onmessage=function(e){J(c.decode(e.data),n),E&&(T=Date.now()+E)},r.onerror=function(e){u.emit("io-error",e),console.error("socket error: ",e)},r.onclose=function(e){u.emit("close",e),u.emit("disconnect",e),console.log("socket close: ",e),t.reconnect&&S<o&&(P=!0,S++,Y=setTimeout(function(){K(t,A,n)},k),k*=2)}};u.disconnect=function(){r&&(r.disconnect&&r.disconnect(),r.close&&r.close(),console.log("disconnect"),r=null),_&&(clearTimeout(_),_=null),w&&(clearTimeout(w),w=null)};var D=function(){P=!1,k=5e3,S=0,clearTimeout(Y)};u.request=function(e,t,n){t=2===arguments.length&&"function"==typeof t?(n=t,{}):t||{},(e=e||t.route)&&(U(++o,e,t),f[o]=n,h[o]=e)},u.notify=function(e,t){U(0,e,t=t||{})};var U=function(e,t,n){if(u.emit("send",{route:t,msg:n}),l){n=JSON.stringify(n);var o=a.signString(n,"sha256");(n=JSON.parse(n)).__crypto__=o}m&&(n=m(e,t,n));var r=c.encode(c.TYPE_DATA,n);C(r)},C=function(e){r.send(e.buffer)},I=function(){var e=T-Date.now();100<e?w=setTimeout(I,e):(console.error("server heartbeat timeout"),u.emit("heartbeat timeout"),u.disconnect())};d[c.TYPE_HANDSHAKE]=function(e){if(501!==(e=JSON.parse(i.strdecode(e))).code)if(200===e.code){j(e);var t=c.encode(c.TYPE_HANDSHAKE_ACK);C(t),O&&O(r)}else u.emit("error","handshake fail");else u.emit("error","client version not fullfill")},d[c.TYPE_HEARTBEAT]=function(e){if(y){var t=c.encode(c.TYPE_HEARTBEAT);w&&(clearTimeout(w),w=null),_=_||setTimeout(function(){_=null,C(t),T=Date.now()+E,w=setTimeout(I,E)},y)}},d[c.TYPE_DATA]=function(e){var t=e;g&&(t=g(t)),L(u,t)},d[c.TYPE_KICK]=function(e){e=JSON.parse(i.strdecode(e)),u.emit("onKick",e)};var J=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];d[n.type](n.body)}else d[e.type](e.body)},L=function(e,t){if(!t.id)return e.emit(t.route,t.body),void e.emit("onReceive",{route:t.route,response:t.body});var n=f[t.id];delete f[t.id],"function"==typeof n&&(e.emit("onReceive",{route:t.route,response:t.body}),n(t.body))},Q=function(e){var t=e.route;if(e.compressRoute){if(!v[t])return{};t=e.route=v[t]}return JSON.parse(i.strdecode(e.body))},j=function(e){E=e.sys&&e.sys.heartbeat?2*(y=1e3*e.sys.heartbeat):y=0,B(e),"function"==typeof b&&b(e.user)},B=function(e){if(e&&e.sys){if(p=e.sys.dict)for(var t in v={},p=p)v[p[t]]=t;window.nano=u}}}();