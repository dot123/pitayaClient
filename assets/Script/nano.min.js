!function(e,p){var y=e,n=y.Package={},r=y.Message={};n.TYPE_HANDSHAKE=1,n.TYPE_HANDSHAKE_ACK=2,n.TYPE_HEARTBEAT=3,n.TYPE_DATA=4,n.TYPE_KICK=5,r.TYPE_REQUEST=0,r.TYPE_NOTIFY=1,r.TYPE_RESPONSE=2,r.TYPE_PUSH=3,y.strencode=function(e){for(var n=new p(3*e.length),t=0,o=0;o<e.length;o++){var r=e.charCodeAt(o),i=null;i=r<=127?[r]:r<=2047?[192|r>>6,128|63&r]:[224|r>>12,128|(4032&r)>>6,128|63&r];for(var c=0;c<i.length;c++)n[t]=i[c],++t}var s=new p(t);return v(s,0,n,0,t),s},y.strdecode=function(e){for(var n=new p(e),t=[],o=0,r=0,i=n.length;o<i;)n[o]<128?(r=n[o],o+=1):n[o]<224?(r=((63&n[o])<<6)+(63&n[o+1]),o+=2):(r=((15&n[o])<<12)+((63&n[o+1])<<6)+(63&n[o+2]),o+=3),t.push(r);return String.fromCharCode.apply(null,t)},n.encode=function(e,n){var t=n?n.length:0,o=new p(4+t),r=0;return o[r++]=255&e,o[r++]=t>>16&255,o[r++]=t>>8&255,o[r++]=255&t,n&&v(o,4,n,0,t),o},n.decode=function(e){for(var n=0,t=new p(e),o=0,r=[];n<t.length;){var i=t[n++],c=(o=(t[n++]<<16|t[n++]<<8|t[n++])>>>0)?new p(o):null;v(c,0,t,n,o),n+=o,r.push({type:i,body:c})}return 1===r.length?r[0]:r},r.encode=function(e,n,t,o,r){var i=1+(E(n)?l(e):0);if(T(n))if(t){if("number"!=typeof o)throw new Error("error flag for number route!");i+=2}else if(i+=1,o){if(255<(o=y.strencode(o)).length)throw new Error("route maxlength is overflow");i+=o.length}r&&(i+=r.length);var c=new p(i),s=0;return s=a(n,t,c,s),E(n)&&(s=u(e,c,s)),T(n)&&(s=f(t,o,c,s)),r&&(s=d(r,c,s)),c},r.decode=function(e){var n=new p(e),t=n.length||n.byteLength,o=0,r=0,i=null,c=n[o++],s=1&c,l=c>>1&7;if(E(l)){var a=parseInt(n[o]),u=0;do{r+=(127&(a=parseInt(n[o])))*Math.pow(2,7*u),o++,u++}while(128<=a)}if(T(l))if(s)i=n[o++]<<8|n[o++];else{var f=n[o++];i=f?(i=new p(f),v(i,0,n,o,f),y.strdecode(i)):"",o+=f}var d=t-o,h=new p(d);return v(h,0,n,o,d),{id:r,type:l,compressRoute:s,route:i,body:h}};var v=function(e,n,t,o,r){if("function"==typeof t.copy)t.copy(e,n,o,o+r);else for(var i=0;i<r;i++)e[n++]=t[o++]},E=function(e){return e===r.TYPE_REQUEST||e===r.TYPE_RESPONSE},T=function(e){return e===r.TYPE_REQUEST||e===r.TYPE_NOTIFY||e===r.TYPE_PUSH},l=function(e){for(var n=0;n+=1,0<(e>>=7););return n},a=function(e,n,t,o){if(e!==r.TYPE_REQUEST&&e!==r.TYPE_NOTIFY&&e!==r.TYPE_RESPONSE&&e!==r.TYPE_PUSH)throw new Error("unkonw message type: "+e);return t[o]=e<<1|(n?1:0),o+1},u=function(e,n,t){do{var o=e%128,r=Math.floor(e/128);0!==r&&(o+=128),n[t++]=o,e=r}while(0!==e);return t},f=function(e,n,t,o){if(e){if(65535<n)throw new Error("route number is overflow");t[o++]=n>>8&255,t[o++]=255&n}else n?(t[o++]=255&n.length,v(t,o,n,0,n.length),o+=n.length):t[o++]=0;return o},d=function(e,n,t){return v(n,t,e,0,e.length),t+e.length};"undefined"!=typeof window&&(window.Protocol=y)}("undefined"==typeof window?module.exports:this.Protocol={},"undefined"==typeof window?Buffer:Uint8Array),function(){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}t.prototype.on=t.prototype.addEventListener=function(e,n){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(n),this},t.prototype.once=function(e,n){var t=this;function o(){t.off(e,o),n.apply(this,arguments)}return this._callbacks=this._callbacks||{},o.fn=n,this.on(e,o),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,n){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var t,o=this._callbacks[e];if(!o)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r=0;r<o.length;r++)if((t=o[r])===n||t.fn===n){o.splice(r,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var n=[].slice.call(arguments,1),t=this._callbacks[e];if(t)for(var o=0,r=(t=t.slice(0)).length;o<r;++o)t[o].apply(this,n);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length};var i=window.Protocol,c=i.Package,s=i.Message,e=t,l=window.rsa;"function"!=typeof Object.create&&(Object.create=function(e){function n(){}return n.prototype=e,new n});var n=window,a=Object.create(e.prototype);n.nano=a;var u,r=null,o=0,f={},d={},h={},p={},y={},v=0,E=0,T=0,_=null,b=null,w=null,m=null,g=null,P=!1,Y=null,A=null,S=0,k=5e3,N={sys:{rsa:{},platform:"",libVersion:"",clientBuildNumber:"",clientVersion:""},user:{}},O=null;a.init=function(e,n){O=n;var t=e.host,o=e.port,r=e.path;g=e.encode||R,m=e.decode||H;var i="ws://"+t;if(o&&(i+=":"+o),r&&(i+=r),N.sys.platform=e.platform||"",N.sys.libVersion="0.0.1",N.sys.clientBuildNumber=e.clientBuildNumber||"",N.sys.clientVersion=e.clientVersion||"",N.user=e.user,e.encrypt){u=!0,l.generate(1024,"10001");var c={rsa_n:l.n.toString(16),rsa_e:l.e};N.sys.rsa=c}w=e.handshakeCallback,K(e,i,n)};var H=a.decode=function(e){var n=s.decode(e);if(!(0<n.id)||(n.route=h[n.id],delete h[n.id],n.route))return n.body=L(n),n},R=a.encode=function(e,n,t){var o=e?s.TYPE_REQUEST:s.TYPE_NOTIFY;t=i.strencode(JSON.stringify(t));var r=0;return p&&p[n]&&(n=p[n],r=1),s.encode(e,o,r,n,t)},K=function(n,e,t){console.log("connect to "+e);var o=(n=n||{}).maxReconnectAttempts||10;(r=new WebSocket(A=e)).binaryType="arraybuffer",r.onopen=function(e){P&&a.emit("reconnect"),D();var n=c.encode(c.TYPE_HANDSHAKE,i.strencode(JSON.stringify(N)));C(n)},r.onmessage=function(e){B(c.decode(e.data),t),E&&(T=Date.now()+E)},r.onerror=function(e){a.emit("io-error",e),console.error("socket error: ",e)},r.onclose=function(e){a.emit("close",e),a.emit("disconnect",e),console.log("socket close: ",e),n.reconnect&&S<o&&(P=!0,S++,Y=setTimeout(function(){K(n,A,t)},k),k*=2)}};a.disconnect=function(){r&&(r.disconnect&&r.disconnect(),r.close&&r.close(),console.log("disconnect"),r=null),_&&(clearTimeout(_),_=null),b&&(clearTimeout(b),b=null)};var D=function(){P=!1,k=5e3,S=0,clearTimeout(Y)};a.request=function(e,n,t){n=2===arguments.length&&"function"==typeof n?(t=n,{}):n||{},(e=e||n.route)&&(U(++o,e,n),f[o]=t,h[o]=e)},a.notify=function(e,n){U(0,e,n=n||{})};var U=function(e,n,t){if(a.emit("send",{route:n,msg:t}),u){t=JSON.stringify(t);var o=l.signString(t,"sha256");(t=JSON.parse(t)).__crypto__=o}g&&(t=g(e,n,t));var r=c.encode(c.TYPE_DATA,t);C(r)},C=function(e){r?r.send(e.buffer):console.error("send fail socket is disconnect")},I=function(){var e=T-Date.now();100<e?b=setTimeout(I,e):(console.error("server heartbeat timeout"),a.emit("heartbeat timeout"),a.disconnect())};d[c.TYPE_HANDSHAKE]=function(e){if(501!==(e=JSON.parse(i.strdecode(e))).code)if(200===e.code){Q(e);var n=c.encode(c.TYPE_HANDSHAKE_ACK);C(n),O&&O(r)}else a.emit("error","handshake fail");else a.emit("error","client version not fullfill")},d[c.TYPE_HEARTBEAT]=function(e){if(v){var n=c.encode(c.TYPE_HEARTBEAT);b&&(clearTimeout(b),b=null),_=_||setTimeout(function(){_=null,C(n),T=Date.now()+E,b=setTimeout(I,E)},v)}},d[c.TYPE_DATA]=function(e){var n=e;m&&(n=m(n)),J(a,n)},d[c.TYPE_KICK]=function(e){e=JSON.parse(i.strdecode(e)),a.emit("onKick",e)};var B=function(e){if(Array.isArray(e))for(var n=0;n<e.length;n++){var t=e[n];d[t.type](t.body)}else d[e.type](e.body)},J=function(e,n){if(!n.id)return e.emit(n.route,n.body),void e.emit("onReceive",{route:n.route,response:n.body});var t=f[n.id];delete f[n.id],"function"==typeof t&&(e.emit("onReceive",{route:n.route,response:n.body}),t(n.body))},L=function(e){var n=e.route;if(e.compressRoute){if(!y[n])return{};n=e.route=y[n]}return JSON.parse(i.strdecode(e.body))},Q=function(e){E=e.sys&&e.sys.heartbeat?2*(v=1e3*e.sys.heartbeat):v=0,V(e),"function"==typeof w&&e.sys&&w(e.sys.serializer)},V=function(e){if(e&&e.sys){if(p=e.sys.dict)for(var n in y={},p=p)y[p[n]]=n;window.nano=a}}}();